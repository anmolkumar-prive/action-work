name: Matrix Example

on:
  push:
    branches: [main]  # Or use "pull_request" for PRs

jobs:
  generate-matrix:
    name: Generate matrix
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.changed-directories.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get list of changed directories
        id: changed-directories
        run: |
          list_changed_directories=$(git diff --diff-filter=d --name-only HEAD^ HEAD ':(exclude)*README.md' | xargs -L1 dirname | uniq | grep -Ev "^\." | sed -e 's/\/templates//;s/\/user-data//;s/\/policies//' | uniq || [[ $? == 1 ]] )
          echo "Changed directories: $list_changed_directories"

          declare -a matrix
          for changed_directory in $list_changed_directories;
          do
            module_name=$(echo $changed_directory | sed -e "s/\//_/g")
            matrix+="{\"module_name\": \"$module_name\", \"module_path\": \"$changed_directory\"},"
          done
          echo "matrix={\"include\":[${matrix%,}]}" >> $GITHUB_OUTPUT
          echo "Final matrix: {\"include\":[${matrix%,}]}"
          
  run-tests:
    name: Run job for each module
    needs: generate-matrix
    runs-on: ubuntu-22.04
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix).include }}
    steps:
      - name: Print module info
        run: |
          echo "Running job for module: ${{ matrix.module_name }}"
          echo "Path: ${{ matrix.module_path }}"
